<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisador de CSV com LLM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        // Configura√ß√£o do Tailwind para suporte a tema escuro
        tailwind.config = {
            darkMode: 'class'
        }
    </script>
    <style>
        :root {
            --bg-primary: #f1f5f9; /* slate-100 */
            --bg-secondary: #ffffff; /* white */
            --bg-tertiary: #f8fafc; /* slate-50 */
            --text-primary: #1e293b; /* slate-800 */
            --text-secondary: #475569; /* slate-600 */
            --text-muted: #64748b; /* slate-500 */
            --border-primary: #e2e8f0; /* slate-200 */
            --border-secondary: #cbd5e1; /* slate-300 */
            --accent-color: #0ea5e9; /* sky-500 */
            --accent-hover: #0284c7; /* sky-600 */
            --warning-color: #f59e0b; /* amber-500 */
            --warning-bg: #fef3c7; /* amber-100 */
        }

        [data-theme="dark"] {
            --bg-primary: #0f172a; /* slate-900 */
            --bg-secondary: #1e293b; /* slate-800 */
            --bg-tertiary: #334155; /* slate-700 */
            --text-primary: #e2e8f0; /* slate-200 */
            --text-secondary: #94a3b8; /* slate-400 */
            --text-muted: #64748b; /* slate-500 */
            --border-primary: #475569; /* slate-600 */
            --border-secondary: #374151; /* slate-700 */
            --accent-color: #38bdf8; /* sky-400 */
            --accent-hover: #0ea5e9; /* sky-500 */
            --warning-color: #fbbf24; /* amber-400 */
            --warning-bg: #451a03; /* amber-950 with low opacity */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .card {
            background-color: var(--bg-secondary);
            border-color: var(--border-primary);
            color: var(--text-primary);
        }

        .input-field {
            background-color: var(--bg-secondary);
            border-color: var(--border-secondary);
            color: var(--text-primary);
        }

        .input-field:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
        }

        .text-secondary {
            color: var(--text-secondary);
        }

        .text-muted {
            color: var(--text-muted);
        }

        .bg-tertiary {
            background-color: var(--bg-tertiary);
        }

        .border-custom {
            border-color: var(--border-primary);
        }

        .btn-primary {
            background-color: var(--accent-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--accent-hover);
        }

        .btn-secondary {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            border-color: var(--border-secondary);
        }

        .btn-secondary:hover {
            background-color: var(--border-primary);
        }

        .warning-box {
            background-color: var(--warning-bg);
            color: var(--warning-color);
            border-color: var(--warning-color);
        }

        .table-header {
            background-color: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .table-cell {
            border-color: var(--border-primary);
            color: var(--text-primary);
        }
        
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: var(--accent-color);
            animation: spin 1s ease infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 0.875rem;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            opacity: 0;
            transition: opacity 0.3s ease, transform 0.3s ease;
            color: white;
        }
        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        .toast.error {
            background-color: #ef4444;
        }
        .toast.success {
            background-color: #22c55e;
        }
        /* Estilos para a tabela de preview do CSV */
        .table-cell {
            padding: 8px 12px;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4 sm:p-6" id="mainBody">

    <!-- Controles superiores -->
    <div class="w-full max-w-2xl mb-4 flex justify-between items-center">
        <div class="flex items-center space-x-2">
            <button id="langToggle" class="px-3 py-1 text-xs btn-secondary rounded-md transition-colors">
                üáßüá∑ PT
            </button>
            <button id="themeToggle" class="p-2 rounded-md btn-secondary transition-colors">
                üåô
            </button>
        </div>
    </div>

    <div class="card shadow-xl rounded-lg p-6 sm:p-8 w-full max-w-2xl border">
        <header class="mb-6 text-center">
            <h1 id="mainTitle" class="text-2xl sm:text-3xl font-bold text-sky-600">Analisador de CSV com LLM</h1>
            <p id="subtitle" class="text-sm text-secondary mt-1">Fa√ßa upload do seu CSV, forne√ßa o contexto e obtenha insights valiosos!</p>
            <p id="securityNote" class="text-xs warning-box p-2 rounded mt-2 border"><strong>Importante:</strong> Esta aplica√ß√£o roda no seu navegador. Sua chave de API n√£o √© armazenada em nenhum servidor, mas √© usada diretamente para se comunicar com a API do Google.</p>
        </header>

        <div class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="md:col-span-3">
                    <label for="apiKey" class="block text-sm font-medium mb-1">Sua Chave de API do Google AI Studio (Gemini):</label>
                    <input type="password" id="apiKey" class="input-field w-full p-2 border rounded-md shadow-sm" placeholder="Cole sua chave de API aqui">
                    <p class="text-xs text-muted mt-1" id="apiKeyHelp">Obtenha sua chave em <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener" class="text-sky-600 hover:underline">Google AI Studio</a>.</p>
                </div>
                <div class="md:col-span-1">
                    <label for="modelSelect" class="block text-sm font-medium mb-1">Modelo:</label>
                    <select id="modelSelect" class="input-field w-full p-2 border rounded-md shadow-sm">
                        <option value="gemini-1.5-flash">Gemini 1.5 Flash</option>
                        <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                        <option value="gemini-2.0-flash">Gemini 2.0 Flash</option>
                    </select>
                </div>
            </div>

            <div>
                <label for="csvFile" class="block text-sm font-medium mb-1">1. Fa√ßa Upload do Arquivo CSV:</label>
                <input type="file" id="csvFile" accept=".csv" aria-label="Selecionar arquivo CSV" class="input-field w-full text-sm
                    file:mr-4 file:py-2 file:px-4
                    file:rounded-md file:border-0
                    file:text-sm file:font-semibold
                    file:bg-sky-50 file:text-sky-700
                    hover:file:bg-sky-100
                ">
                <div id="fileName" class="text-xs text-muted mt-1"></div>
            </div>

            <div id="csvPreviewSection" class="mt-4 hidden">
                <h3 class="text-md font-semibold mb-2">Pr√©-visualiza√ß√£o dos Dados (Cabe√ßalho e Primeiras 5 Linhas):</h3>
                <div class="overflow-x-auto bg-tertiary p-3 rounded-md shadow-sm border border-custom">
                    <table id="csvPreviewTable" class="min-w-full text-sm divide-y">
                        </table>
                </div>
            </div>

            <div>
                <label for="context" class="block text-sm font-medium mb-1">2. Forne√ßa o Contexto da Planilha:</label>
                <textarea id="context" rows="4" class="input-field w-full p-2 border rounded-md shadow-sm" placeholder="Ex: Dados de vendas trimestrais de produtos eletr√¥nicos. 'Qty' √© quantidade vendida, 'Rev' √© receita em BRL. O objetivo √© identificar tend√™ncias de vendas."></textarea>
            </div>

            <div class="text-center">
                <button id="analyzeButton" class="btn-primary font-semibold py-2 px-6 rounded-md shadow-md transition duration-150 ease-in-out disabled:opacity-50">
                    Analisar Dados
                </button>
                <div id="loadingIndicator" class="hidden flex justify-center items-center mt-4">
                    <div class="spinner"></div>
                    <p id="loadingText" class="ml-2 text-secondary">Analisando... Isso pode levar alguns instantes.</p>
                </div>
            </div>
        </div>

        <div id="resultsSection" class="mt-8 pt-6 border-t border-custom hidden">
            <h2 class="text-xl sm:text-2xl font-semibold text-sky-600 mb-4">Resultados da An√°lise:</h2>
            <div id="analysisOutput" class="prose prose-sm max-w-none bg-tertiary p-4 rounded-md shadow overflow-x-auto">
                </div>
        </div>
    </div>

    <div id="toast" class="toast">
        <span id="toastMessage"></span>
    </div>

    <footer class="text-center text-xs text-muted mt-8 pb-4">
        Desenvolvido para portf√≥lio.
    </footer>

    <script>
        // ===== AN√ÅLISE ESTAT√çSTICA LOCAL =====
        
        // Utilit√°rios matem√°ticos
        function getMedian(values) {
            const sorted = values.slice().sort((a, b) => a - b);
            const mid = Math.floor(sorted.length / 2);
            return sorted.length % 2 !== 0 ? sorted[mid] : (sorted[mid - 1] + sorted[mid]) / 2;
        }
        
        function getStandardDeviation(values) {
            const mean = values.reduce((a, b) => a + b) / values.length;
            const variance = values.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / values.length;
            return Math.sqrt(variance);
        }
        
        function getQuartiles(values) {
            const sorted = values.slice().sort((a, b) => a - b);
            const q1Index = Math.floor(sorted.length * 0.25);
            const q3Index = Math.floor(sorted.length * 0.75);
            return {
                q1: sorted[q1Index],
                q3: sorted[q3Index],
                iqr: sorted[q3Index] - sorted[q1Index]
            };
        }
        
        function detectOutliers(values) {
            const quartiles = getQuartiles(values);
            const lowerBound = quartiles.q1 - 1.5 * quartiles.iqr;
            const upperBound = quartiles.q3 + 1.5 * quartiles.iqr;
            return values.filter(v => v < lowerBound || v > upperBound);
        }
        
        // Detec√ß√£o de tipos de colunas
        function detectColumnType(data, column) {
            const values = data.map(row => row[column]).filter(v => v !== null && v !== undefined && v !== '');
            if (values.length === 0) return 'empty';
            
            const numericValues = values.map(v => parseFloat(v)).filter(v => !isNaN(v));
            const numericRatio = numericValues.length / values.length;
            
            if (numericRatio > 0.8) {
                // Verificar se s√£o datas
                const dateValues = values.filter(v => !isNaN(Date.parse(v)));
                if (dateValues.length / values.length > 0.8) return 'date';
                
                // Verificar se s√£o inteiros
                const integerRatio = numericValues.filter(v => Number.isInteger(v)).length / numericValues.length;
                return integerRatio > 0.9 ? 'integer' : 'numeric';
            }
            
            const uniqueRatio = new Set(values).size / values.length;
            return uniqueRatio < 0.1 ? 'categorical' : 'text';
        }
        
        // An√°lise estat√≠stica por coluna
        function analyzeColumn(data, column) {
            const columnType = detectColumnType(data, column);
            const values = data.map(row => row[column]).filter(v => v !== null && v !== undefined && v !== '');
            const nullCount = data.length - values.length;
            
            const analysis = {
                name: column,
                type: columnType,
                totalCount: data.length,
                validCount: values.length,
                nullCount: nullCount,
                nullPercentage: (nullCount / data.length * 100).toFixed(2)
            };
            
            if (columnType === 'numeric' || columnType === 'integer') {
                const numericValues = values.map(v => parseFloat(v)).filter(v => !isNaN(v));
                if (numericValues.length > 0) {
                    const quartiles = getQuartiles(numericValues);
                    const outliers = detectOutliers(numericValues);
                    
                    analysis.statistics = {
                        mean: (numericValues.reduce((a, b) => a + b) / numericValues.length).toFixed(2),
                        median: getMedian(numericValues).toFixed(2),
                        std: getStandardDeviation(numericValues).toFixed(2),
                        min: Math.min(...numericValues),
                        max: Math.max(...numericValues),
                        q1: quartiles.q1.toFixed(2),
                        q3: quartiles.q3.toFixed(2),
                        iqr: quartiles.iqr.toFixed(2),
                        outliers: outliers.length,
                        outliersPercentage: (outliers.length / numericValues.length * 100).toFixed(2)
                    };
                }
            } else if (columnType === 'categorical' || columnType === 'text') {
                const valueCounts = {};
                values.forEach(v => valueCounts[v] = (valueCounts[v] || 0) + 1);
                const sortedCounts = Object.entries(valueCounts).sort((a, b) => b[1] - a[1]);
                
                analysis.categories = {
                    uniqueValues: Object.keys(valueCounts).length,
                    uniqueRatio: (Object.keys(valueCounts).length / values.length).toFixed(3),
                    topValues: sortedCounts.slice(0, 5).map(([value, count]) => ({
                        value: value,
                        count: count,
                        percentage: (count / values.length * 100).toFixed(2)
                    }))
                };
            } else if (columnType === 'date') {
                const dates = values.map(v => new Date(v)).filter(d => !isNaN(d.getTime()));
                if (dates.length > 0) {
                    dates.sort((a, b) => a - b);
                    analysis.dateRange = {
                        earliest: dates[0].toISOString().split('T')[0],
                        latest: dates[dates.length - 1].toISOString().split('T')[0],
                        span: Math.ceil((dates[dates.length - 1] - dates[0]) / (1000 * 60 * 60 * 24))
                    };
                }
            }
            
            return analysis;
        }
        
        // An√°lise de correla√ß√µes (apenas colunas num√©ricas)
        function calculateCorrelations(data, numericColumns) {
            if (numericColumns.length < 2) return {};
            
            const correlations = {};
            
            for (let i = 0; i < numericColumns.length; i++) {
                for (let j = i + 1; j < numericColumns.length; j++) {
                    const col1 = numericColumns[i];
                    const col2 = numericColumns[j];
                    
                    const pairs = data.map(row => ({
                        x: parseFloat(row[col1]),
                        y: parseFloat(row[col2])
                    })).filter(pair => !isNaN(pair.x) && !isNaN(pair.y));
                    
                    if (pairs.length > 2) {
                        const correlation = calculatePearsonCorrelation(pairs);
                        if (Math.abs(correlation) > 0.1) { // S√≥ incluir correla√ß√µes relevantes
                            correlations[`${col1}_${col2}`] = {
                                columns: [col1, col2],
                                correlation: correlation.toFixed(3),
                                strength: getCorrelationStrength(correlation),
                                sampleSize: pairs.length
                            };
                        }
                    }
                }
            }
            
            return correlations;
        }
        
        function calculatePearsonCorrelation(pairs) {
            const n = pairs.length;
            const sumX = pairs.reduce((sum, p) => sum + p.x, 0);
            const sumY = pairs.reduce((sum, p) => sum + p.y, 0);
            const sumXY = pairs.reduce((sum, p) => sum + p.x * p.y, 0);
            const sumX2 = pairs.reduce((sum, p) => sum + p.x * p.x, 0);
            const sumY2 = pairs.reduce((sum, p) => sum + p.y * p.y, 0);
            
            const numerator = n * sumXY - sumX * sumY;
            const denominator = Math.sqrt((n * sumX2 - sumX * sumX) * (n * sumY2 - sumY * sumY));
            
            return denominator === 0 ? 0 : numerator / denominator;
        }
        
        function getCorrelationStrength(r) {
            const abs = Math.abs(r);
            if (abs >= 0.7) return 'forte';
            if (abs >= 0.4) return 'moderada';
            if (abs >= 0.2) return 'fraca';
            return 'muito fraca';
        }
        
        // An√°lise completa do dataset
        function performLocalAnalysis(data) {
            if (!data || data.length === 0) return null;
            
            const columns = Object.keys(data[0]);
            const columnAnalyses = columns.map(col => analyzeColumn(data, col));
            
            const numericColumns = columnAnalyses
                .filter(analysis => analysis.type === 'numeric' || analysis.type === 'integer')
                .map(analysis => analysis.name);
            
            const categoricalColumns = columnAnalyses
                .filter(analysis => analysis.type === 'categorical')
                .map(analysis => analysis.name);
            
            const dateColumns = columnAnalyses
                .filter(analysis => analysis.type === 'date')
                .map(analysis => analysis.name);
            
            const correlations = calculateCorrelations(data, numericColumns);
            
            // Sum√°rio de qualidade dos dados
            const totalCells = data.length * columns.length;
            const nullCells = columnAnalyses.reduce((sum, col) => sum + col.nullCount, 0);
            const dataQuality = {
                completeness: ((totalCells - nullCells) / totalCells * 100).toFixed(2),
                totalRows: data.length,
                totalColumns: columns.length,
                totalCells: totalCells,
                nullCells: nullCells
            };
            
            return {
                dataQuality,
                columns: columnAnalyses,
                numericColumns,
                categoricalColumns,
                dateColumns,
                correlations,
                summary: generateIntelligentSummary({
                    dataQuality,
                    columns: columnAnalyses,
                    numericColumns,
                    categoricalColumns,
                    dateColumns,
                    correlations
                })
            };
        }
        
        // Gera√ß√£o de sum√°rio inteligente para LLM
        function generateIntelligentSummary(analysis) {
            let summary = `AN√ÅLISE ESTAT√çSTICA COMPLETA DO DATASET\n\n`;
            
            // Vis√£o geral
            summary += `## Vis√£o Geral\n`;
            summary += `- ${analysis.dataQuality.totalRows} registros, ${analysis.dataQuality.totalColumns} colunas\n`;
            summary += `- Completude dos dados: ${analysis.dataQuality.completeness}%\n`;
            summary += `- Tipos: ${analysis.numericColumns.length} num√©ricas, ${analysis.categoricalColumns.length} categ√≥ricas, ${analysis.dateColumns.length} temporais\n\n`;
            
            // An√°lise por colunas
            summary += `## An√°lise Detalhada por Coluna\n`;
            analysis.columns.forEach(col => {
                summary += `### ${col.name} (${col.type})\n`;
                summary += `- Valores v√°lidos: ${col.validCount}/${col.totalCount} (${(100 - parseFloat(col.nullPercentage)).toFixed(1)}%)\n`;
                
                if (col.statistics) {
                    summary += `- Estat√≠sticas: Œº=${col.statistics.mean}, œÉ=${col.statistics.std}, mediana=${col.statistics.median}\n`;
                    summary += `- Range: ${col.statistics.min} - ${col.statistics.max}\n`;
                    summary += `- Outliers: ${col.statistics.outliers} (${col.statistics.outliersPercentage}%)\n`;
                }
                
                if (col.categories) {
                    summary += `- Valores √∫nicos: ${col.categories.uniqueValues} (diversidade: ${col.categories.uniqueRatio})\n`;
                    summary += `- Valores mais frequentes: ${col.categories.topValues.map(v => `${v.value} (${v.percentage}%)`).join(', ')}\n`;
                }
                
                if (col.dateRange) {
                    summary += `- Per√≠odo: ${col.dateRange.earliest} a ${col.dateRange.latest} (${col.dateRange.span} dias)\n`;
                }
                
                summary += `\n`;
            });
            
            // Correla√ß√µes
            const correlationEntries = Object.entries(analysis.correlations);
            if (correlationEntries.length > 0) {
                summary += `## Correla√ß√µes Identificadas\n`;
                correlationEntries.forEach(([key, corr]) => {
                    summary += `- ${corr.columns[0]} ‚Üî ${corr.columns[1]}: r=${corr.correlation} (${corr.strength})\n`;
                });
                summary += `\n`;
            }
            
            return summary;
        }

        // Sistema de internacionaliza√ß√£o
        const translations = {
            pt: {
                mainTitle: "Analisador de CSV com LLM",
                subtitle: "Fa√ßa upload do seu CSV, forne√ßa o contexto e obtenha insights valiosos com an√°lise estat√≠stica completa!",
                securityNote: "<strong>Importante:</strong> Esta aplica√ß√£o roda no seu navegador. Sua chave de API n√£o √© armazenada em nenhum servidor, mas √© usada diretamente para se comunicar com a API do Google.",
                apiKeyLabel: "Sua Chave de API do Google AI Studio (Gemini):",
                apiKeyPlaceholder: "Cole sua chave de API aqui",
                apiKeyHelp: "Obtenha sua chave em Google AI Studio.",
                csvFileLabel: "1. Fa√ßa Upload do Arquivo CSV:",
                previewTitle: "Pr√©-visualiza√ß√£o dos Dados (Cabe√ßalho e Primeiras 5 Linhas):",
                contextLabel: "2. Forne√ßa o Contexto da Planilha:",
                contextPlaceholder: "Ex: Dados de vendas trimestrais de produtos eletr√¥nicos. 'Qty' √© quantidade vendida, 'Rev' √© receita em BRL. O objetivo √© identificar tend√™ncias de vendas.",
                analyzeButton: "Analisar Dados",
                loadingText: "Analisando estatisticamente todo o dataset... Isso pode levar alguns instantes.",
                resultsTitle: "Resultados da An√°lise:",
                footerText: "Desenvolvido para portf√≥lio.",
                fileSelected: "Arquivo selecionado:",
                errors: {
                    missingApiKey: "Por favor, insira sua chave de API do Google AI Studio.",
                    missingCsv: "Por favor, fa√ßa upload de um arquivo CSV v√°lido e processado.",
                    missingContext: "Por favor, forne√ßa o contexto para a planilha.",
                    csvParse: "Erro ao fazer o parse do CSV:",
                    csvEmpty: "CSV vazio ou inv√°lido ap√≥s o parse.",
                    csvLoad: "Erro ao carregar o arquivo CSV:",
                    papaParseNotLoaded: "Erro: Biblioteca PapaParse n√£o carregada. Verifique sua conex√£o ou tente recarregar a p√°gina.",
                    markedNotLoaded: "Erro: Biblioteca Marked.js n√£o carregada.",
                    analysisError: "Erro na an√°lise:",
                    rateLimitRetrying: "Limite de taxa atingido. Tentando novamente em"
                },
                success: {
                    analysisComplete: "An√°lise conclu√≠da com sucesso!"
                }
            },
            en: {
                mainTitle: "CSV Analyzer with LLM",
                subtitle: "Upload your CSV, provide context and get valuable insights with complete statistical analysis!",
                securityNote: "<strong>Important:</strong> This application runs in your browser. Your API key is not stored on any server, but is used directly to communicate with Google's API.",
                apiKeyLabel: "Your Google AI Studio (Gemini) API Key:",
                apiKeyPlaceholder: "Paste your API key here",
                apiKeyHelp: "Get your key at Google AI Studio.",
                csvFileLabel: "1. Upload CSV File:",
                previewTitle: "Data Preview (Header and First 5 Rows):",
                contextLabel: "2. Provide Spreadsheet Context:",
                contextPlaceholder: "Ex: Quarterly sales data for electronics. 'Qty' is quantity sold, 'Rev' is revenue in USD. Goal is to identify sales trends.",
                analyzeButton: "Analyze Data",
                loadingText: "Statistically analyzing entire dataset... This may take a few moments.",
                resultsTitle: "Analysis Results:",
                footerText: "Developed for portfolio.",
                fileSelected: "Selected file:",
                errors: {
                    missingApiKey: "Please enter your Google AI Studio API key.",
                    missingCsv: "Please upload a valid and processed CSV file.",
                    missingContext: "Please provide context for the spreadsheet.",
                    csvParse: "Error parsing CSV:",
                    csvEmpty: "Empty or invalid CSV after parsing.",
                    csvLoad: "Error loading CSV file:",
                    papaParseNotLoaded: "Error: PapaParse library not loaded. Check your connection or try reloading the page.",
                    markedNotLoaded: "Error: Marked.js library not loaded.",
                    analysisError: "Analysis error:",
                    rateLimitRetrying: "Rate limit hit. Retrying in"
                },
                success: {
                    analysisComplete: "Analysis completed successfully!"
                }
            }
        };

        let currentLang = 'pt';
        let isDarkMode = false;

        function updateLanguage() {
            const t = translations[currentLang];
            
            document.getElementById('mainTitle').textContent = t.mainTitle;
            document.getElementById('subtitle').textContent = t.subtitle;
            document.getElementById('securityNote').innerHTML = t.securityNote;
            document.querySelector('label[for="apiKey"]').textContent = t.apiKeyLabel;
            document.getElementById('apiKey').placeholder = t.apiKeyPlaceholder;
            document.getElementById('apiKeyHelp').innerHTML = t.apiKeyHelp + ' <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener" class="text-sky-600 hover:underline">Google AI Studio</a>.';
            document.querySelector('label[for="csvFile"]').textContent = t.csvFileLabel;
            document.querySelector('label[for="context"]').textContent = t.contextLabel;
            document.getElementById('context').placeholder = t.contextPlaceholder;
            document.getElementById('analyzeButton').textContent = t.analyzeButton;
            
            const previewTitle = document.querySelector('#csvPreviewSection h3');
            if (previewTitle) previewTitle.textContent = t.previewTitle;
            
            const resultsTitle = document.querySelector('#resultsSection h2');
            if (resultsTitle) resultsTitle.textContent = t.resultsTitle;
            
            document.querySelector('footer').textContent = t.footerText;
            
            // Atualizar bot√£o de idioma
            document.getElementById('langToggle').textContent = currentLang === 'pt' ? 'üá∫üá∏ EN' : 'üáßüá∑ PT';
        }

        function toggleTheme() {
            isDarkMode = !isDarkMode;
            const body = document.getElementById('mainBody');
            const themeToggle = document.getElementById('themeToggle');
            
            if (isDarkMode) {
                document.documentElement.setAttribute('data-theme', 'dark');
                themeToggle.textContent = '‚òÄÔ∏è';
            } else {
                document.documentElement.removeAttribute('data-theme');
                themeToggle.textContent = 'üåô';
            }
            
            // Salvar prefer√™ncia
            localStorage.setItem('darkMode', isDarkMode);
        }

        function toggleLanguage() {
            currentLang = currentLang === 'pt' ? 'en' : 'pt';
            updateLanguage();
            localStorage.setItem('language', currentLang);
        }

        // Carregar prefer√™ncias salvas
        function loadPreferences() {
            const savedLang = localStorage.getItem('language');
            const savedTheme = localStorage.getItem('darkMode');
            
            if (savedLang && translations[savedLang]) {
                currentLang = savedLang;
            }
            
            if (savedTheme === 'true') {
                isDarkMode = true;
                document.documentElement.setAttribute('data-theme', 'dark');
                document.getElementById('themeToggle').textContent = '‚òÄÔ∏è';
            }
            
            updateLanguage();
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadPreferences();
            
            document.getElementById('langToggle').addEventListener('click', toggleLanguage);
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            const apiKeyInput = document.getElementById('apiKey');
            const csvFileInput = document.getElementById('csvFile');
            const fileNameDisplay = document.getElementById('fileName');
            const contextInput = document.getElementById('context');
            const analyzeButton = document.getElementById('analyzeButton');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const resultsSection = document.getElementById('resultsSection');
            const analysisOutput = document.getElementById('analysisOutput');
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            const csvPreviewSection = document.getElementById('csvPreviewSection');
            const csvPreviewTable = document.getElementById('csvPreviewTable');

            let parsedCsvData = null;

            function showToast(message, type = 'error') {
                toastMessage.textContent = message;
                toast.className = `toast show ${type}`;
                setTimeout(() => {
                    toast.className = 'toast';
                }, 3000);
            }

            function getTranslation(key) {
                const keys = key.split('.');
                let value = translations[currentLang];
                for (const k of keys) {
                    value = value[k];
                    if (!value) return key;
                }
                return value;
            }

            function displayCsvPreview(data) {
                csvPreviewTable.innerHTML = ''; // Limpa pr√©-visualiza√ß√£o anterior

                if (!data || data.length === 0) {
                    csvPreviewSection.classList.add('hidden');
                    return;
                }

                const headers = Object.keys(data[0]);
                const thead = csvPreviewTable.createTHead();
                thead.className = "table-header";
                const headerRow = thead.insertRow();
                headers.forEach(headerText => {
                    const th = document.createElement('th');
                    th.className = 'px-3 py-2 text-left text-xs font-medium uppercase tracking-wider table-cell';
                    th.textContent = headerText;
                    headerRow.appendChild(th);
                });

                const tbody = csvPreviewTable.createTBody();
                tbody.className = 'divide-y';
                const rowsToDisplay = data.slice(0, 5);
                rowsToDisplay.forEach(rowData => {
                    const row = tbody.insertRow();
                    headers.forEach(header => {
                        const cell = row.insertCell();
                        cell.className = 'px-3 py-2 whitespace-nowrap table-cell';
                        cell.textContent = rowData[header] !== undefined && rowData[header] !== null ? String(rowData[header]) : '';
                    });
                });
                csvPreviewSection.classList.remove('hidden');
            }

            csvFileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    fileNameDisplay.textContent = `${getTranslation('fileSelected')} ${file.name}`;
                    csvPreviewSection.classList.add('hidden');
                    if (typeof Papa !== 'undefined') {
                        Papa.parse(file, {
                            header: true,
                            skipEmptyLines: true,
                            complete: (results) => {
                                if (results.errors.length > 0) {
                                    showToast(getTranslation('errors.csvParse') + " " + results.errors[0].message, 'error');
                                    parsedCsvData = null;
                                    displayCsvPreview(null);
                                    return;
                                }
                                parsedCsvData = results.data;
                                if (!parsedCsvData || parsedCsvData.length === 0) {
                                     showToast(getTranslation('errors.csvEmpty'), 'error');
                                     parsedCsvData = null;
                                }
                                displayCsvPreview(parsedCsvData);
                            },
                            error: (error) => {
                                showToast(getTranslation('errors.csvLoad') + " " + error.message, 'error');
                                parsedCsvData = null;
                                fileNameDisplay.textContent = '';
                                displayCsvPreview(null);
                            }
                        });
                    } else {
                        showToast(getTranslation('errors.papaParseNotLoaded'), 'error');
                        fileNameDisplay.textContent = '';
                        parsedCsvData = null;
                        displayCsvPreview(null);
                    }
                } else {
                    parsedCsvData = null;
                    fileNameDisplay.textContent = '';
                    displayCsvPreview(null);
                }
            });

            analyzeButton.addEventListener('click', async () => {
                const apiKey = apiKeyInput.value.trim();
                const userContext = contextInput.value.trim();

                if (!apiKey) {
                    showToast(getTranslation('errors.missingApiKey'), 'error');
                    return;
                }
                if (!parsedCsvData || parsedCsvData.length === 0) {
                    showToast(getTranslation('errors.missingCsv'), 'error');
                    return;
                }
                if (!userContext) {
                    showToast(getTranslation('errors.missingContext'), 'error');
                    return;
                }

                loadingIndicator.classList.remove('hidden');
                analyzeButton.disabled = true;
                resultsSection.classList.add('hidden');
                analysisOutput.innerHTML = ''; // Limpa resultados anteriores

                try {
                    // üî• NOVA ABORDAGEM: An√°lise estat√≠stica local completa
                    console.log('Iniciando an√°lise estat√≠stica local...');
                    const localAnalysis = performLocalAnalysis(parsedCsvData);
                    
                    if (!localAnalysis) {
                        throw new Error('Falha na an√°lise estat√≠stica local dos dados.');
                    }
                    
                    console.log('An√°lise local conclu√≠da:', localAnalysis);
                    
                    // Criar prompt otimizado com sum√°rio estat√≠stico
                    const prompt = `
Voc√™ √© um analista de dados s√™nior especialista. Analise o sum√°rio estat√≠stico abaixo e forne√ßa insights acion√°veis baseados no contexto fornecido pelo usu√°rio.

CONTEXTO DO USU√ÅRIO:
${userContext}

AN√ÅLISE ESTAT√çSTICA COMPLETA:
${localAnalysis.summary}

Com base nesta an√°lise estat√≠stica completa (n√£o em dados brutos), forne√ßa insights estruturados em Markdown:

## üîç **Insights Principais**
(2-3 descobertas mais importantes baseadas nas estat√≠sticas)

## üìä **An√°lise de Qualidade dos Dados**
(Avalie completude, outliers, distribui√ß√µes e problemas identificados)

## üîó **Padr√µes e Correla√ß√µes**
(Interprete as correla√ß√µes encontradas e seus significados pr√°ticos)

## üí° **Recomenda√ß√µes Estrat√©gicas**
(3-4 a√ß√µes espec√≠ficas baseadas nos padr√µes identificados)

## ‚ö†Ô∏è **Pontos de Aten√ß√£o**
(Limita√ß√µes dos dados, outliers significativos, poss√≠veis vieses)

## üöÄ **Oportunidades de An√°lise Futura**
(Sugest√µes para aprofundamento com base nos padr√µes encontrados)

Foque em insights pr√°ticos e acion√°veis, n√£o em repetir as estat√≠sticas.
                    `;

                    const selectedModel = document.getElementById('modelSelect').value;
                    const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${selectedModel}:generateContent?key=${apiKey}`;
                    
                    const payload = {
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: {
                            temperature: 0.7,
                            maxOutputTokens: 2048
                        }
                    };

                    // Fun√ß√£o de Retry com Backoff Exponencial
                    async function fetchWithRetry(url, payload, maxRetries = 3) {
                        let retries = 0;
                        while (true) {
                            try {
                                const response = await fetch(url, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify(payload),
                                });

                                if (response.status === 429 || response.status === 503) {
                                    if (retries >= maxRetries) return response; // Retorna o erro para ser tratado
                                    
                                    const waitTime = 2000 * Math.pow(2, retries); // 2s, 4s, 8s
                                    console.warn(`Rate limit hit (${response.status}). Retrying in ${waitTime}ms...`);
                                    
                                    // Atualiza toast
                                    showToast(`${getTranslation('errors.rateLimitRetrying')} ${waitTime/1000}s...`, 'warning');
                                    
                                    await new Promise(resolve => setTimeout(resolve, waitTime));
                                    retries++;
                                    continue;
                                }
                                
                                return response;
                            } catch (error) {
                                if (retries >= maxRetries) throw error;
                                console.error("Network error, retrying...", error);
                                await new Promise(resolve => setTimeout(resolve, 2000));
                                retries++;
                            }
                        }
                    }

                    const response = await fetchWithRetry(API_URL, payload);

                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error("Erro da API:", errorData);
                        throw new Error(`Erro da API (${response.status}): ${errorData.error?.message || response.statusText}`);
                    }

                    const result = await response.json();
                    
                    let llmResponseText = "N√£o foi poss√≠vel extrair a resposta do LLM ou a resposta estava vazia.";
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0 &&
                        result.candidates[0].content.parts[0].text) {
                        llmResponseText = result.candidates[0].content.parts[0].text;
                    } else {
                         console.warn("Estrutura de resposta inesperada ou vazia do LLM:", result);
                    }

                    if (typeof marked !== 'undefined') {
                        // Configura o marked para usar <br> para quebras de linha simples dentro de par√°grafos
                        marked.setOptions({
                            breaks: true, // Adiciona <br> para quebras de linha simples
                            gfm: true // Habilita GitHub Flavored Markdown (melhor para tabelas, etc., se o LLM usar)
                        });
                        
                        // Adicionar sum√°rio estat√≠stico como se√ß√£o expand√≠vel
                        const fullAnalysis = `
## üìà **An√°lise Estat√≠stica Detalhada**
<details>
<summary><strong>Clique para ver estat√≠sticas completas do dataset</strong></summary>

\`\`\`
${localAnalysis.summary}
\`\`\`

**Dados processados:** ${localAnalysis.dataQuality.totalRows.toLocaleString()} registros √ó ${localAnalysis.dataQuality.totalColumns} colunas
**Completude:** ${localAnalysis.dataQuality.completeness}%
**Correla√ß√µes encontradas:** ${Object.keys(localAnalysis.correlations).length}

</details>

---

${llmResponseText}`;
                        
                        analysisOutput.innerHTML = marked.parse(fullAnalysis);
                    } else {
                        analysisOutput.textContent = "Erro: Biblioteca Marked.js n√£o carregada. A formata√ß√£o pode estar incorreta.\n\n" + llmResponseText;
                        showToast("Erro: Biblioteca Marked.js n√£o carregada.", 'error');
                    }
                    resultsSection.classList.remove('hidden');
                    showToast(getTranslation('success.analysisComplete'), 'success');

                } catch (error) {
                    console.error("Erro durante a an√°lise:", error);
                    analysisOutput.innerHTML = `<strong>Ocorreu um erro durante a an√°lise:</strong><br>${error.message.replace(/\n/g, "<br>")}<br><br>Verifique o console para mais detalhes. Certifique-se de que sua chave de API √© v√°lida e tem acesso ao modelo gemini-2.0-flash.`;
                    resultsSection.classList.remove('hidden');
                    showToast(`${getTranslation('errors.analysisError')} ${error.message}`, 'error');
                } finally {
                    loadingIndicator.classList.add('hidden');
                    analyzeButton.disabled = false;
                }
            });
        });
    </script>
</body>
</html>
